<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <!-- ============================================
       CyberCore - IIS Upload Folder Security
       /assets/uploads - Restrictive web.config
       Purpose: Prevent PHP execution, limit upload types
       ============================================ -->

  <system.webServer>
    <!-- ============================================
         1. DENY SCRIPT EXECUTION
         ============================================ -->
    <security>
      <requestFiltering>
        <!-- Blocked executable extensions -->
        <fileExtensions>
          <add fileExtension=".php" allowed="false" />
          <add fileExtension=".php3" allowed="false" />
          <add fileExtension=".php4" allowed="false" />
          <add fileExtension=".php5" allowed="false" />
          <add fileExtension=".phtml" allowed="false" />
          <add fileExtension=".phar" allowed="false" />
          <add fileExtension=".pht" allowed="false" />
          <add fileExtension=".phps" allowed="false" />
          <add fileExtension=".asp" allowed="false" />
          <add fileExtension=".aspx" allowed="false" />
          <add fileExtension=".jsp" allowed="false" />
          <add fileExtension=".jspx" allowed="false" />
          <add fileExtension=".jspf" allowed="false" />
          <add fileExtension=".pl" allowed="false" />
          <add fileExtension=".py" allowed="false" />
          <add fileExtension=".rb" allowed="false" />
          <add fileExtension=".sh" allowed="false" />
          <add fileExtension=".exe" allowed="false" />
          <add fileExtension=".bat" allowed="false" />
          <add fileExtension=".cmd" allowed="false" />
          <add fileExtension=".com" allowed="false" />
          <add fileExtension=".svg" allowed="false" />
          <add fileExtension=".htaccess" allowed="false" />
        </fileExtensions>

        <!-- Block double extensions (shell.php.jpg) -->
        <fileExtensions>
          <add fileExtension=".php.txt" allowed="false" />
          <add fileExtension=".php.jpg" allowed="false" />
          <add fileExtension=".php.png" allowed="false" />
          <add fileExtension=".php.gif" allowed="false" />
          <add fileExtension=".php.pdf" allowed="false" />
          <add fileExtension=".php.zip" allowed="false" />
          <add fileExtension=".php.doc" allowed="false" />
          <add fileExtension=".php.docx" allowed="false" />
          <add fileExtension=".asp.jpg" allowed="false" />
          <add fileExtension=".aspx.jpg" allowed="false" />
        </fileExtensions>

        <!-- Block null bytes and suspicious patterns -->
        <denyUrlSequences>
          <add sequence="%00" />
          <add sequence=".." />
          <add sequence="..\" />
          <add sequence="../" />
          <add sequence=".%2e" />
          <add sequence="%2e." />
          <add sequence="%2e%2e" />
        </denyUrlSequences>

        <!-- Request size: 10MB max -->
        <requestLimits maxAllowedContentLength="10485760" />
      </requestFiltering>
    </security>

    <!-- ============================================
         2. BLOCK DIRECT ACCESS VIA HANDLER
         ============================================ -->
    <handlers>
      <!-- Remove all non-static handlers for this folder -->
      <add name="BlockPHP" path="*.php" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="File" allowed="false" />
      <add name="BlockASP" path="*.asp" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="File" allowed="false" />
      <add name="BlockASPX" path="*.aspx" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="File" allowed="false" />
      <add name="BlockJSP" path="*.jsp" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="File" allowed="false" />
      
      <!-- Allow only static file types through -->
      <add name="StaticFile" path="*" verb="*" modules="StaticFileModule" resourceType="Either" requireAccess="Read" />
    </handlers>

    <!-- ============================================
         3. MIME TYPE RESTRICTIONS
         ============================================ -->
    <staticContent>
      <!-- ALLOWED: Images -->
      <mimeMap fileExtension=".jpg" mimeType="image/jpeg" />
      <mimeMap fileExtension=".jpeg" mimeType="image/jpeg" />
      <mimeMap fileExtension=".png" mimeType="image/png" />
      <mimeMap fileExtension=".gif" mimeType="image/gif" />
      <mimeMap fileExtension=".webp" mimeType="image/webp" />
      
      <!-- ALLOWED: Documents -->
      <mimeMap fileExtension=".pdf" mimeType="application/pdf" />
      <mimeMap fileExtension=".doc" mimeType="application/msword" />
      <mimeMap fileExtension=".docx" mimeType="application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
      <mimeMap fileExtension=".xls" mimeType="application/vnd.ms-excel" />
      <mimeMap fileExtension=".xlsx" mimeType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
      <mimeMap fileExtension=".zip" mimeType="application/zip" />
      
      <!-- BLOCK: Executable types (explicitly) -->
      <mimeMap fileExtension=".exe" mimeType="application/octet-stream" />
      <mimeMap fileExtension=".bat" mimeType="application/octet-stream" />
      <mimeMap fileExtension=".cmd" mimeType="application/octet-stream" />
      <mimeMap fileExtension=".sh" mimeType="application/octet-stream" />
      
      <!-- Prevent MIME sniffing on uploads -->
      <clientCache cacheControlMode="NoControl" />
    </staticContent>

    <!-- ============================================
         4. SECURITY HEADERS (even for uploads)
         ============================================ -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="DENY" />
        <add name="Content-Disposition" value="attachment" />
        <add name="Cache-Control" value="no-cache, no-store, must-revalidate" />
      </customHeaders>
    </httpProtocol>

    <!-- ============================================
         5. DISABLE DIRECTORY BROWSING
         ============================================ -->
    <directoryBrowse enabled="false" />

    <!-- ============================================
         6. ERROR HANDLING (Generic)
         ============================================ -->
    <httpErrors errorMode="Custom" defaultResponseMode="File">
      <error statusCode="403" path="403.htm" />
      <error statusCode="404" path="404.htm" />
    </httpErrors>

  </system.webServer>

  <!-- ============================================
       7. LOCATION DIRECTIVE (Alternative)
       If above not enough, use location to override parent
       ============================================ -->
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <clear />
        <add name="StaticFile" path="*" verb="*" modules="StaticFileModule" resourceType="Either" requireAccess="Read" />
      </handlers>
    </system.webServer>
  </location>

</configuration>
