<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <!-- ============================================
       CyberCore - IIS Production Security Configuration
       Windows Server + Plesk + PHP 8.1
       Purpose: Replace Apache .htaccess entirely
       ============================================ -->

  <!-- ============================================
       1. URL REWRITING & HTTPS ENFORCEMENT
       ============================================ -->
  <system.webServer>
    <rewrite>
      <rules>
        <!-- Force HTTPS (301 redirect) -->
        <rule name="ForceHTTPS" enabled="true" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="^OFF$" />
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}{REQUEST_URI}" redirectType="Permanent" />
        </rule>

        <!-- Block SQL injection patterns -->
        <rule name="BlockSQLInjection" enabled="true" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAny">
            <add input="{QUERY_STRING}" pattern="(union|select|insert|drop|grant|update|delete|--|javascript|script|cookie)" />
            <add input="{QUERY_STRING}" pattern="(exec|execute|script|jscript|vbscript|onload)" />
          </conditions>
          <action type="AbortRequest" />
        </rule>

        <!-- Block file injection attempts -->
        <rule name="BlockFileInjection" enabled="true" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{QUERY_STRING}" pattern="[a-zA-Z0-9_]=http://" />
          </conditions>
          <action type="AbortRequest" />
        </rule>

        <!-- Block path traversal -->
        <rule name="BlockPathTraversal" enabled="true" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{URL}" pattern="\.\." />
          </conditions>
          <action type="AbortRequest" />
        </rule>

        <!-- Block vulnerability scanners -->
        <rule name="BlockScanners" enabled="true" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{HTTP_USER_AGENT}" pattern="(nikto|nmap|nessus|openvas|masscan|shodan)" ignoreCase="true" />
          </conditions>
          <action type="AbortRequest" />
        </rule>
      </rules>
    </rewrite>

    <!-- ============================================
         2. SECURITY HEADERS
         ============================================ -->
    <httpProtocol>
      <customHeaders>
        <!-- Prevent clickjacking -->
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        
        <!-- Prevent MIME sniffing -->
        <add name="X-Content-Type-Options" value="nosniff" />
        
        <!-- XSS Protection -->
        <add name="X-XSS-Protection" value="1; mode=block" />
        
        <!-- Referrer Policy -->
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
        
        <!-- Content Security Policy (strict but functional) -->
        <add name="Content-Security-Policy" value="default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; form-action 'self'; frame-ancestors 'self';" />
        
        <!-- Permissions Policy (Feature Policy) -->
        <add name="Permissions-Policy" value="geolocation=(), microphone=(), camera=(), payment=()" />
        
        <!-- Strict Transport Security (HSTS) - 1 year, includes subdomains -->
        <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains; preload" />
        
        <!-- Remove server signature -->
        <add name="Server" value="" />
      </customHeaders>
    </httpProtocol>

    <!-- ============================================
         3. DIRECTORY & FILE PROTECTION
         ============================================ -->
    <authorization>
      <deny users="?" />
    </authorization>

    <!-- ============================================
         4. REQUEST FILTERING (Comprehensive)
         ============================================ -->
    <security>
      <requestFiltering>
        <!-- Block access to sensitive files -->
        <fileExtensions>
          <add fileExtension=".env" allowed="false" />
          <add fileExtension=".htaccess" allowed="false" />
          <add fileExtension=".htpasswd" allowed="false" />
          <add fileExtension=".user.ini" allowed="false" />
          <add fileExtension=".git" allowed="false" />
          <add fileExtension=".gitignore" allowed="false" />
          <add fileExtension=".sql" allowed="false" />
          <add fileExtension=".log" allowed="false" />
          <add fileExtension=".bak" allowed="false" />
        </fileExtensions>

        <!-- Block double extensions (e.g., shell.php.txt) -->
        <fileExtensions>
          <add fileExtension=".php.txt" allowed="false" />
          <add fileExtension=".php.jpg" allowed="false" />
          <add fileExtension=".php.png" allowed="false" />
        </fileExtensions>

        <!-- Block null bytes and suspicious characters -->
        <hiddenSegments>
          <add segment=".env" />
          <add segment=".git" />
          <add segment=".gitignore" />
          <add segment="config" />
          <add segment="inc" />
          <add segment="sql" />
          <add segment="scripts" />
          <add segment="vendor" />
          <add segment="node_modules" />
        </hiddenSegments>

        <!-- Request size limits -->
        <requestLimits maxAllowedContentLength="10485760" maxQueryString="4096" />

        <!-- Deny access to command execution -->
        <verbs>
          <add verb="TRACE" allowed="false" />
          <add verb="TRACK" allowed="false" />
        </verbs>
      </requestFiltering>
    </security>

    <!-- ============================================
         5. MIME TYPE CONFIGURATION
         ============================================ -->
    <staticContent>
      <!-- Block executable MIME types -->
      <mimeMap fileExtension=".bat" mimeType="text/plain" />
      <mimeMap fileExtension=".cmd" mimeType="text/plain" />
      <mimeMap fileExtension=".com" mimeType="text/plain" />
      <mimeMap fileExtension=".exe" mimeType="text/plain" />
      <mimeMap fileExtension=".sh" mimeType="text/plain" />
      
      <!-- Allow modern web types -->
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
      <mimeMap fileExtension=".webp" mimeType="image/webp" />
      
      <!-- Remove IIS default caching for PHP -->
      <clientCache cacheControlMode="NoControl" />
    </staticContent>

    <!-- ============================================
         6. COMPRESSION & CACHING
         ============================================ -->
    <httpCompression directory="%SystemDrive%\inetpub\temp\IIS Temporary Compressed Files">
      <scheme name="gzip" dll="%Windir%\system32\inetsrv\gzip.dll" staticCompressionLevel="9" />
      <staticTypes>
        <add mimeType="text/html" enabled="true" />
        <add mimeType="text/plain" enabled="true" />
        <add mimeType="text/css" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/xml" enabled="true" />
        <add mimeType="image/svg+xml" enabled="true" />
      </staticTypes>
      <dynamicTypes>
        <add mimeType="text/html" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="text/xml" enabled="true" />
      </dynamicTypes>
    </httpCompression>

    <caching>
      <profiles>
        <!-- Static assets cache: 1 year -->
        <add extension=".jpg" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".jpeg" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".png" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".gif" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".svg" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".webp" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".ico" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".woff" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".woff2" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".ttf" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        
        <!-- CSS/JS cache: 1 month -->
        <add extension=".css" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
        <add extension=".js" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
      </profiles>
    </caching>

    <!-- ============================================
         7. DEFAULT DOCUMENT
         ============================================ -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.php" />
        <add value="index.html" />
        <add value="index.htm" />
      </files>
    </defaultDocument>

    <!-- ============================================
         8. ERROR HANDLING
         ============================================ -->
    <httpErrors errorMode="Detailed" defaultPath="/404.php" defaultResponseMode="File">
      <error statusCode="403" prefixLanguageFILEPath="" path="/no_access.php" responseMode="File" />
      <error statusCode="404" prefixLanguageFILEPath="" path="/404.php" responseMode="File" />
      <error statusCode="500" prefixLanguageFILEPath="" path="/404.php" responseMode="File" />
    </httpErrors>

    <!-- ============================================
         9. PHP HANDLER (FastCGI)
         ============================================ -->
    <handlers>
      <!-- PHP 8.1 FastCGI (Plesk standard) -->
      <add name="PHP-FastCGI" path="*.php" verb="GET,HEAD,POST" modules="FastCgiModule" scriptProcessor="C:\Program Files\Plesk\Additional\PleskPHP81\php-cgi.exe" resourceType="Either" requireAccess="Script" />
      
      <!-- Block direct execution of sensitive scripts -->
      <add name="BlockEnv" path=".env*" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="File" requireAccess="Script" allowed="false" />
      <add name="BlockConfig" path="config/*" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="Folder" requireAccess="Script" allowed="false" />
      <add name="BlockInc" path="inc/*" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="Folder" requireAccess="Script" allowed="false" />
      <add name="BlockSQL" path="sql/*" verb="*" modules="IsapiModule" scriptProcessor="" resourceType="Folder" requireAccess="Script" allowed="false" />
    </handlers>

    <!-- ============================================
         10. URL ROUTING (Clean URLs)
         ============================================ -->
    <iisnode>
      <debuggingEnabled>false</debuggingEnabled>
      <loggingEnabled>true</loggingEnabled>
      <logDirectory>%SystemDrive%\logs</logDirectory>
    </iisnode>

    <!-- ============================================
         11. DIRECTORY BROWSE DISABLED
         ============================================ -->
    <directoryBrowse enabled="false" />

  </system.webServer>

  <!-- ============================================
       12. APPLICATION POOL SETTINGS (Web.config level)
       ============================================ -->
  <system.applicationHost>
    <applicationPool>
      <!-- These should be set in Plesk ApplicationPool, but documented here -->
      <!-- Identity: ApplicationPoolIdentity (least privilege) -->
      <!-- Enable 32-bit: False (PHP 8.1 is 64-bit) -->
      <!-- Queue Length: 1000 -->
      <!-- Idle Timeout: 20 minutes -->
      <!-- Periodic Restart: 1740 minutes (29 hours) -->
    </applicationPool>
  </system.applicationHost>

  <!-- ============================================
       13. RUNTIME CONFIGURATION
       ============================================ -->
  <runtime>
    <!-- Enforce strong types and error handling -->
    <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
      <probing privatePath="bin" />
    </assemblyBinding>
  </runtime>

</configuration>
